{"title":"Module 4.2: Population Structure","markdown":{"headingText":"Module 4.2: Population Structure","containsRefs":false,"markdown":"\nPopulation structure in crop breeding refers to the **presence of clusters or subpopulations that are genetically distinct** from each other. The subpopulations may reflect geography, breeding history, natural selection, gene pools, or other differentiating factors. The subgroups are identified by differences in allele frequencies.\n\n## Why is it important?\n\n-   Allows us to **detect subpopulations** and understand **genetic diversity**\n\n-   Can be used **to control bias in GWAS** or other **genomic prediction models** (by including structure information as covariates), as not accounting for structure may lead to spurious associations (false-positives)\n\n-   Acknowledging structure can help **guide breeding programs**\n\n## Common methods\n\n-   **STRUCTURE / ADMIXTURE:** Uses Bayesian clustering or Maximum Likelihood (ML) estimation to assign individuals into subpopulations, including admixture proportions for each individual.\n\n-   **Principal Component Analysis (PCA):** Used to reduce dimentionality of large data sets, and to visualize overall diversity and major genetic groupings.\n\n-   **Spatial Principal Component Analysis (sPCA):** Incorporates spatial information (geographic location) intro traditional PCA, meaning it seeks to maximize spatial autocorrelation along with variation. It allows us to identify global and local trends.\n\n-   **Discriminant Analysis of Principal Components (DAPC)**: Used to assign individuals to groups, provide a visual assessment of between-population differentiation and the contribution of individual alleles to the population structure.\n\n-   **Sparse Non-negative Matrix Factorization (sNMF):** Fast algorithm used to infer structure by estimating ancestry coefficients. Allows us to evaluate levels of admixture. More efficient than STRUCTURE for large data sets.\n\nAll methods are complementary to each other and using them in combination can help us fully understand structure in our data.\n\n|                                                |      |\n|------------------------------------------------|------|\n| Want to **explore structure** quickly?         | PCA  |\n| Want to **analyze spatial genetic variation**? | sPCA |\n| Need to **classify individuals into groups**?  | DAPC |\n| Need to **estimate admixture proportions**?    | sNMF |\n\nWe will be using functions from our package to carry out and visualize most of these analyses.\n\n## PCA\n\nPCA reduces our large genotype matrix into principal components which capture the variation in our data. We will use the `PCAFromMatrix()` function from our package. This function uses the PCA framework from the `ade4` package. This function returns a list with three objects, the first one being a PCA, the second one being a data frame with the variance explained by each component, and the third one being a plot of the PCA results (1st and 2nd PCs).\n\n`PCAFromMatrix(geno, subgroups = NULL)`: returns a *pca* object from genotype matrix\n\n-   `geno`: our genotype matrix\n\n-   `subgroups`: defaults to NULL, can be replaced with a vector of our factor information\n\n```{r setup, include=FALSE}\nlibrary(here)\nsource(here(\"code\",\"setup.R\"))\n```\n\n```{r data-import-run, include=FALSE}\n# Importing filtered genotypic data\nmatrix <- read.table(here(\"data\", \"FilteredBarley.txt\"), sep = \"\\t\", header = TRUE, row.names = 1, check.names = FALSE)\n# SNP matrix has to have individuals in rows and markers as columns for the posterior functions\nmatrix <- t(matrix)\n\n# Importing metadata\nmetadata <- read_excel(here(\"data\", \"BarleyMetadata.xlsx\"))\nmetadata <- metadata[metadata$Individual %in% rownames(matrix),] #Ensuring IDs match\n```\n\n```{r data-import, eval=FALSE}\n# Importing filtered genotypic data\nmatrix <- read.table(\"data/FilteredBarley.txt\", sep = \"\\t\", header = TRUE, row.names = 1, check.names = FALSE)\n# SNP matrix has to have individuals in rows and markers as columns for the posterior functions\nmatrix <- t(matrix)\n\n# Importing metadata\nmetadata <- read_excel(\"data/BarleyMetadata.xlsx\")\n```\n\n```{r pca}\n# We will be guiding our analysis by the 'countryOfOriginCode' column from our metadata\n# Defining our subgroups\npopSet <- as.factor(metadata$countryOfOriginCode[metadata$Individual %in% rownames(matrix)])\n# Running our pca using our genotype data and groups\npca <- PCAFromMatrix(matrix, popSet)\n\n# Printing pca object\npca$pca\n\n# Printing PC variation\nhead(pca$var)\n\n# Plotting pca results\npca$plot\n```\n\n## sPCA\n\nWe will be using the `sPCA()` function from our package. This function uses the sPCA framework from the `adegenet` package. It returns a list with our sPCA object, a plot of the obtained eigenvalues, results and plots for the global test and results and plots for the local test. The obtained sPCA result can be plotted using the `sPCAMapPlot()` function.\n\n`sPCA(geno, subgroups = NULL, xy, eigenPlot = TRUE, tests = TRUE)`: returns sPCA from genotype data\n\n-   `geno`: our genotype matrix\n\n-   `subgroups`: defaults to NULL, can be replaced with a vector of our factor information\n\n-   `xy`: a two column longitude - latitude vector or data frame\n\n-   `eigenPlot`: defaults to TRUE, plots the resulting eigenvalues\n\n-   `tests`: defaults to TRUE, carries out global and local tests\n\n`sPCAMapPlot(spca, geno, xy, axis = 1, pos = TRUE`): plots our sPCA results on a map\n\n-   `spca`: our *spca* object\n\n-   `geno`: our genotype matrix\n\n-   `xy`: a two column longitude - latitude vector or data frame\n\n-   `axis`: defaults to 1 (our first axis), we can choose any other axis to plot\n\n-   `pos`: defaults to TRUE to plot the positive values, can be set to FALSE to plot the negative values\n\n```{r spca, eval=FALSE}\n# Running sPCA\nspca <- sPCA(matrix, subgroups = popSet, xy = metadata[,c(\"LON\",\"LAT\")], eigenPlot = TRUE, tests = TRUE)\n\n# Plotting our obtained eigenvalues\nspca$eigenPlot\n\n# Plotting global test results\nspca$globalTest\n\n# Plotting local test results\nspca$localTest\n\n# Plotting our results in a map\nsPCAMapPlot(spca$spca, matrix, xy = metadata[,c(\"LON\",\"LAT\")], axis = 1, pos = TRUE)\n```\n\n## DAPC\n\nDAPC requires the user to define a range of subpopulation numbers for which to perform the analyses. To do this, we can calculate different k-statistics to guide our choice of this range. We will be using our `kMeansStats()` function, which allows us to choose between `\"BIC\"`, `\"AIC\"` or `\"WCC\"` for our desired k-statistic. This function outputs a data frame with our k-statistic values, and a plot. We will then use our `DAPC()` function on our genotype data, which uses the DAPC framework from the `adegenet` package. This function outputs a list with the *dapc* object and a data frame with the explained variances. An additional plot can also be produced.\n\n`kMeansStats(geno, pca = NULL, maxK, stat)`: returns test statistic results for different K values\n\n-   `geno`: our genotype matrix\n\n-   `pca`: defaults to NULL, can be replaced by a *pca* object to skip over creating a new PCA\n\n-   `maxK`: the maximum number of K subpopulations for which to calculate k-statistics\n\n-   `stat`: type of k-statistic to calculate\n\nDAPC(geno, krange, subgroups = NULL, pca = NULL, dapcPlot = FALSE): performs DAPC\n\n-   `geno`: our genotype matrix\n\n-   `krange`: a range of K values\n\n-   `subgroups`: defaults to NULL, can be replaced with a vector of our factor information\n\n-   `pca`: defaults to NULL, can be replaced by a *pca* object to skip over creating a new PCA\n\n-   `dapcPlot`: defaults to FALSE, if TRUE, an output plot is produced\n\n```{r dapc}\n# Calculating our K statistics\nBICDAPC <- kMeansStats(matrix, pca$pca, 10, \"BIC\")\n\n# Plotting K statistic\nBICDAPC$statPlot\n\n# Running DAPC\nDAPC <- DAPC(matrix, krange = 3:6, pca = pca$pca, subgroups = popSet, dapcPlot = TRUE)\n\n# Plotting DAPC results\nDAPC$dapcPlot\n```\n\nOur resulting DAPC outputs group assignments for each individual, which can be visualized through a composition plot.\n\n`DAPCCompoPlot(DAPC, geno, krange, subgroups = NULL)`: returns a composition plot of DAPC results\n\n-   `DAPC`: a *dapc* object\n\n-   `geno`: our genotype matrix\n\n-   `krange`: a range of K values\n\n-   `subgroups`: defaults to NULL, can be replaced with a vector of our factor information\n\n```{r DAPC-compo, warning=FALSE, message = FALSE, fig.width=8, fig.height=4}\nDAPCCompoPlot(DAPC$dapc, matrix, krange = 3:6, subgroups = popSet)\n```\n\nWe can also produce a frequency plot from our DAPC. This helps us understand the relationship between the produced group assignments and prior group information we may have.\n\n`DAPCFreqPlot(DAPC, subgroups)`: produced a frequency plot of our DAPC results\n\n-   `DAPC`: a *dapc* object\n\n-   `subgroups`: a vector of our factor information\n\n```{r freq-plot, warning=FALSE, message = FALSE}\n# For k = 3, which is our first object in our DAPC object\nDAPCFreqPlot(DAPC$dapc[[1]], subgroups = popSet)\n```\n\n## sNMF\n\nsNMF is used to estimate admixture proportions: how much of an individualâ€™s genome comes from different ancestral populations. This means that individuals are not just assigned to a population, instead membership probabilities (admixture coefficients) are calculated. We will be using functions from our package to carry out these analyses. The framework they use comes from the `LEA` package. Prior to estimating ancestry coefficients, this package requires us to create a *geno* type object, which we will create using the `write.geno.mod()` function. We can then run our main function using `sNMFFunction()`, which outputs a list with our *snmf* object, a matrix with the produced ancestry coefficients, and a data frame with cross-entropy values. The latter can guide our choice of best K value.\n\n`write.geno.mod(geno, output.file)`: creates *geno* type object from genotype matrix\n\n-   `geno`: our genotype matrix\n\n-   `output`.file: file path where to save our object\n\n`sNMFFunction(geno, file, maxK, subgroups = NULL, cePlot = TRUE)`: outputs ancestry coefficients\n\n-   `geno`: our genotype matrix\n\n-   `file`: file path of *geno* object\n\n-   `maxK`: the maximum number of K subpopulations\n\n-   `subgroups`: defaults to NULL, can be replaced with a vector of our factor information\n\n-   `cePlot`: defaults to TRUE, outputs a plot of cross-entropy values\n\n```{r sNMF-run, include=FALSE}\n# Creating 'geno' object needed to run sNMF\nwrite.geno.mod(matrix, here(\"output\",\"sNMFgenoBarley.geno\"))\n\n# Running sNMF\nsNMF <- sNMFFunction(matrix, subgroups = popSet, here(\"output\",\"sNMFgenoBarley.geno\"), maxK = 6, cePlot = TRUE)\n```\n\n```{r sNMF, eval=FALSE}\n# Creating 'geno' object needed to run sNMF\nwrite.geno.mod(matrix, \"output/sNMFgenoBarley.geno\")\n\n# Running sNMF\nsNMF <- sNMFFunction(matrix, subgroups = popSet, \"output/sNMFgenoBarley.geno\", maxK = 6, cePlot = TRUE)\n```\n\nWe can visualize our membership probability results using a composition plot.\n\n`sNMFCompoPlot(sNMFmatrix, geno, krange, subgroups = NULL)`: returns a composition plot of admixture results\n\n-   `sNMFmatrix`: ancestry coefficient matrix\n\n-   `geno`: our genotype matrix\n\n-   `krange`: a range of K values\n\n-   `subgroups`: defaults to NULL, can be replaced with a vector of our factor information\n\n```{r sNMF-compo}\n# Plotting composition plot\nsNMFCompoPlot(sNMF$qmatrix, matrix, krange = 2:6, subgroups = popSet)\n```\n\nFinally, we can also visualize our sNMF results on a map by incorporating spatial information if available.\n\n`sNMFMapPlot(geno, sNMFObjectVar, xy, k, Xlim = NULL, Ylim = NULL)`: produces a map plot from ancestry coefficient results for a specific number of subgroups\n\n-   `geno`: our genotype matrix\n\n-   `sNMFObjectVar`: a *snmf* object\n\n-   `xy`: a two column longitude - latitude vector or data frame\n\n-   `k`: a number K of subpopulations\n\n-   `Xlim`: defaults to NULL, can be replaced by a range of longitudes to zoom in the map\n\n-   `Ylim`: defaults to NULL, can be replaced by a range of latitudes to zoom in the map\n\n```{r sNMF-map}\n# Plotting results in map\nsNMFMapPlot(matrix, sNMF$snmf, xy = metadata[,c(\"LON\",\"LAT\")], 3)\n```\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"02_Pop_Structure.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","bibliography":["../references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","toc":true,"toc-depth":3,"output-file":"02_Pop_Structure.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"block-headings":true,"bibliography":["../references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf","revealjs","beamer"]}